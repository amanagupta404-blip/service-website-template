---
/**
 * Blog Index Page
 * Display all blog posts with filtering and pagination
 */

import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Container from '@components/layout/Container.svelte';
import Section from '@components/layout/Section.svelte';
import BlogCard from '@components/ui/BlogCard.svelte';

// Get all blog posts, sorted by date (newest first)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) =>
  b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

// Get unique tags for filtering
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))];
---

<BaseLayout
  title="Blog"
  description="Insights, tutorials, and industry news from our team. Stay up to date with the latest in web development, design, and technology."
>
  <main id="main-content">
    <!-- Page Header -->
    <Section backgroundColor="primary" paddingY="large">
      <Container maxWidth="xl">
        <div class="text-center max-w-3xl mx-auto">
          <h1 class="text-5xl md:text-6xl font-bold mb-6">
            Our Blog
          </h1>
          <p class="text-xl md:text-2xl text-secondary leading-relaxed">
            Insights, tutorials, and industry perspectives from our team. Learn about modern web development, design trends, and digital strategy.
          </p>
        </div>
      </Container>
    </Section>

    <!-- Tag Filter Section -->
    <Section backgroundColor="secondary" paddingY="medium">
      <Container maxWidth="xl">
        <div class="text-center">
          <h2 class="text-2xl font-bold mb-4">Filter by Topic</h2>
          <div class="flex flex-wrap justify-center gap-3">
            <button
              class="tag-filter-button active"
              data-tag="all"
              type="button"
            >
              All Posts
            </button>
            {allTags.map((tag) => (
              <button
                class="tag-filter-button"
                data-tag={tag}
                type="button"
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </Container>
    </Section>

    <!-- Blog Posts Grid -->
    <Section backgroundColor="primary" paddingY="large">
      <Container maxWidth="xl">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="blog-grid">
          {sortedPosts.map((post) => (
            <div class="blog-post-item" data-tags={JSON.stringify(post.data.tags)}>
              <BlogCard
                blogTitle={post.data.title}
                excerpt={post.data.description}
                image={post.data.image}
                date={post.data.publishDate.toISOString().split('T')[0]}
                author={post.data.author}
                readTime={post.data.readTime}
                category={post.data.category}
                href={`/blog/${post.slug}`}
                client:load
              />
            </div>
          ))}
        </div>

        <!-- No results message -->
        <div id="no-results" class="text-center py-12 hidden">
          <p class="text-xl text-secondary">
            No posts found for this topic. Try selecting a different filter.
          </p>
        </div>
      </Container>
    </Section>

    <!-- Newsletter CTA -->
    <Section backgroundColor="tertiary" paddingY="large">
      <Container maxWidth="xl">
        <div class="max-w-2xl mx-auto text-center">
          <h2 class="text-4xl font-bold mb-4">Stay Updated</h2>
          <p class="text-xl text-secondary mb-8">
            Subscribe to our newsletter for the latest articles, tutorials, and industry insights delivered to your inbox.
          </p>
          <form class="flex flex-col sm:flex-row gap-4 max-w-lg mx-auto">
            <input
              type="email"
              placeholder="Your email address"
              class="flex-1 px-4 py-3 rounded-lg border-2 border-color focus:border-accent focus:outline-none"
              required
              aria-label="Email address"
            />
            <button
              type="submit"
              class="px-6 py-3 bg-accent-primary text-bg-primary font-semibold rounded-lg hover:opacity-90 transition-opacity"
            >
              Subscribe
            </button>
          </form>
        </div>
      </Container>
    </Section>
  </main>
</BaseLayout>

<style>
  .tag-filter-button {
    padding: 0.5rem 1.25rem;
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
    border: 2px solid transparent;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tag-filter-button:hover {
    background: var(--color-accent-primary);
    color: var(--color-bg-primary);
    transform: translateY(-2px);
  }

  .tag-filter-button.active {
    background: var(--color-accent-primary);
    color: var(--color-bg-primary);
    border-color: var(--color-accent-primary);
  }

  .blog-post-item {
    transition: opacity 0.3s ease;
  }

  .blog-post-item.hidden {
    display: none;
  }
</style>

<script>
  // Client-side tag filtering
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.tag-filter-button');
    const blogPosts = document.querySelectorAll('.blog-post-item');
    const noResults = document.getElementById('no-results');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');

        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // Filter posts
        let visibleCount = 0;
        blogPosts.forEach(post => {
          const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');

          if (selectedTag === 'all' || postTags.includes(selectedTag)) {
            post.classList.remove('hidden');
            visibleCount++;
          } else {
            post.classList.add('hidden');
          }
        });

        // Show/hide no results message
        if (visibleCount === 0) {
          noResults?.classList.remove('hidden');
        } else {
          noResults?.classList.add('hidden');
        }
      });
    });
  });
</script>
